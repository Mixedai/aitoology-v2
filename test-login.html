<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Supabase Login Test</title>
</head>
<body>
    <h1>Direct Supabase Login Test</h1>
    
    <form id="loginForm">
        <input type="email" id="email" placeholder="Email" value="demo@test.com" />
        <input type="password" id="password" placeholder="Password" value="Demo123456!" />
        <button type="submit">Login</button>
    </form>
    
    <div id="result"></div>
    <button onclick="checkSession()">Check Session</button>
    <button onclick="logout()">Logout</button>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://tbvfyhtkrvetmcibalfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidmZ5aHRrcnZldG1jaWJhbGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMzg3MzYsImV4cCI6MjA3MTgxNDczNn0.depr2savD-hvx6f18aZJLfvg7oWBLBxlDu4q9tmkg3w';
        
        const supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: true,
                storageKey: 'sb-auth-token',
                storage: window.localStorage,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                debug: true
            }
        });
        
        // Make functions available globally
        window.supabase = supabase;
        
        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event, session?.user?.email);
            document.getElementById('result').innerHTML = `
                <h3>Auth State: ${event}</h3>
                <p>User: ${session?.user?.email || 'None'}</p>
                <p>Session: ${session ? 'Active' : 'None'}</p>
            `;
        });
        
        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log('Attempting login:', email);
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                console.log('Login successful!', data);
                document.getElementById('result').innerHTML = `
                    <h3 style="color: green;">✅ Login Successful!</h3>
                    <p>User: ${data.user.email}</p>
                    <p>ID: ${data.user.id}</p>
                    <p>Token: ${data.session.access_token.substring(0, 20)}...</p>
                    <button onclick="location.href='http://localhost:5173'">Go to App</button>
                `;
                
                // Check localStorage
                const stored = localStorage.getItem('sb-auth-token');
                console.log('Stored in localStorage:', stored ? 'Yes' : 'No');
                
            } catch (error) {
                console.error('Login failed:', error);
                document.getElementById('result').innerHTML = `
                    <h3 style="color: red;">❌ Login Failed</h3>
                    <p>${error.message}</p>
                `;
            }
        });
        
        // Check session function
        window.checkSession = async () => {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            console.log('Session check:', session);
            
            document.getElementById('result').innerHTML = `
                <h3>Current Session</h3>
                <p>User: ${session?.user?.email || 'None'}</p>
                <p>Expires: ${session ? new Date(session.expires_at * 1000).toLocaleString() : 'N/A'}</p>
                <p>Storage: ${localStorage.getItem('sb-auth-token') ? 'Has token' : 'No token'}</p>
            `;
        };
        
        // Logout function
        window.logout = async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
            } else {
                console.log('Logged out');
                document.getElementById('result').innerHTML = '<p>Logged out</p>';
            }
        };
        
        // Initial session check
        checkSession();
    </script>
</body>
</html>