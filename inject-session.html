<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session Injector</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .step {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body>
    <h1>üîê Session Injection Helper</h1>
    
    <div class="step">
        <h2>Step 1: Login at Test Page</h2>
        <p>First, make sure you're logged in at the test page:</p>
        <button onclick="window.open('test-login.html', '_blank')">Open Test Login Page</button>
        <p>Login with: <strong>demo@test.com</strong> / <strong>Demo123456!</strong></p>
    </div>

    <div class="step">
        <h2>Step 2: Copy Session from Test Page</h2>
        <p>After logging in successfully at test page, click below to copy the session:</p>
        <button onclick="copyFromTestPage()">Copy Session from Test Page</button>
        <div id="copyStatus"></div>
    </div>

    <div class="step">
        <h2>Step 3: Inject Session to Main App</h2>
        <p>Session data to inject:</p>
        <textarea id="sessionData" placeholder="Session data will appear here..."></textarea>
        <button onclick="injectSession()">Inject Session to localhost:5173</button>
        <button onclick="window.open('http://localhost:5173', '_blank')">Open Main App</button>
        <div id="injectStatus"></div>
    </div>

    <div class="step">
        <h2>Debug Info</h2>
        <button onclick="checkCurrentSession()">Check Current Session</button>
        <button onclick="clearAll()">Clear All Sessions</button>
        <div id="debugInfo"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://tbvfyhtkrvetmcibalfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidmZ5aHRrcnZldG1jaWJhbGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMzg3MzYsImV4cCI6MjA3MTgxNDczNn0.depr2savD-hvx6f18aZJLfvg7oWBLBxlDu4q9tmkg3w';
        
        const supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: true,
                storageKey: 'sb-auth-token',
                storage: window.localStorage,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                debug: true
            }
        });
        
        window.supabase = supabase;
        
        // Copy session from current context
        window.copyFromTestPage = async () => {
            const statusEl = document.getElementById('copyStatus');
            
            try {
                // Get current session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (session) {
                    // Store session data
                    const sessionData = {
                        access_token: session.access_token,
                        refresh_token: session.refresh_token,
                        expires_in: session.expires_in,
                        expires_at: session.expires_at,
                        token_type: session.token_type,
                        user: session.user
                    };
                    
                    document.getElementById('sessionData').value = JSON.stringify(sessionData, null, 2);
                    statusEl.innerHTML = '<span class="success">‚úÖ Session copied! Now inject it to main app.</span>';
                    
                    // Also get from localStorage
                    const stored = localStorage.getItem('sb-auth-token');
                    if (stored) {
                        console.log('Found in localStorage:', stored);
                    }
                } else {
                    statusEl.innerHTML = '<span class="error">‚ùå No session found. Please login first at test page.</span>';
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
        
        // Inject session
        window.injectSession = () => {
            const statusEl = document.getElementById('injectStatus');
            const sessionData = document.getElementById('sessionData').value;
            
            if (!sessionData) {
                statusEl.innerHTML = '<span class="error">‚ùå No session data to inject</span>';
                return;
            }
            
            try {
                const session = JSON.parse(sessionData);
                
                // Create the storage format
                const storageData = {
                    url: supabaseUrl,
                    storageKey: 'sb-auth-token',
                    body: JSON.stringify({
                        currentSession: {
                            access_token: session.access_token,
                            refresh_token: session.refresh_token,
                            expires_in: session.expires_in,
                            expires_at: session.expires_at,
                            token_type: session.token_type,
                            user: session.user
                        },
                        expiresAt: session.expires_at
                    })
                };
                
                // Set in localStorage
                localStorage.setItem('sb-tbvfyhtkrvetmcibalfb-auth-token', JSON.stringify(storageData.body));
                localStorage.setItem('sb-auth-token', JSON.stringify(storageData.body));
                
                // Generate script for main app console
                const script = `
// Run this in the main app console (localhost:5173)
const sessionData = ${JSON.stringify(storageData.body)};
localStorage.setItem('sb-tbvfyhtkrvetmcibalfb-auth-token', sessionData);
localStorage.setItem('sb-auth-token', sessionData);
location.reload();
`;
                
                statusEl.innerHTML = `
                    <span class="success">‚úÖ Session injected to this domain!</span>
                    <br><br>
                    <strong>Now copy and run this in the main app console:</strong>
                    <textarea style="margin-top: 10px; height: 150px;">${script}</textarea>
                `;
                
                console.log('Script to run in main app:', script);
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
        
        // Check current session
        window.checkCurrentSession = async () => {
            const debugEl = document.getElementById('debugInfo');
            
            const { data: { session }, error } = await supabase.auth.getSession();
            const stored1 = localStorage.getItem('sb-auth-token');
            const stored2 = localStorage.getItem('sb-tbvfyhtkrvetmcibalfb-auth-token');
            
            debugEl.innerHTML = `
                <div class="status">
                    <strong>Current Session:</strong> ${session ? '‚úÖ Active' : '‚ùå None'}<br>
                    <strong>User:</strong> ${session?.user?.email || 'Not logged in'}<br>
                    <strong>Expires:</strong> ${session ? new Date(session.expires_at * 1000).toLocaleString() : 'N/A'}<br>
                    <br>
                    <strong>localStorage Keys:</strong><br>
                    - sb-auth-token: ${stored1 ? '‚úÖ Present' : '‚ùå Not found'}<br>
                    - sb-tbvfyhtkrvetmcibalfb-auth-token: ${stored2 ? '‚úÖ Present' : '‚ùå Not found'}<br>
                </div>
            `;
        };
        
        // Clear all sessions
        window.clearAll = async () => {
            await supabase.auth.signOut();
            localStorage.removeItem('sb-auth-token');
            localStorage.removeItem('sb-tbvfyhtkrvetmcibalfb-auth-token');
            document.getElementById('debugInfo').innerHTML = '<span class="success">‚úÖ All sessions cleared</span>';
            document.getElementById('sessionData').value = '';
        };
        
        // Check on load
        window.addEventListener('load', () => {
            checkCurrentSession();
        });
    </script>
</body>
</html>